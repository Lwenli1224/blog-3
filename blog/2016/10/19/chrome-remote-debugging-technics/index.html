<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>揭秘浏览器远程调试技术 | Taobao FED | 淘宝前端团队</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="baidu-site-verification" content="OTHOW5vFFG" />
  <meta name="uyan_auth" content="5c52f7795a" />
  <meta name="description" content="调试技术的起源1947 年 9 月 9 日，一名美国的科学家格蕾丝.霍普和她的同伴在对 Mark II 计算机进行研究的时候发现，一只飞蛾粘在一个继电器上，导致计算机无法正常工作，当他们把飞蛾移除之后，计算机又恢复了正常运转。于是他们将这只飞蛾贴在了他们当时记录的日志上，对这件事情进行了详细的记录，并在日志最后写了这样一句话：First actual case of bug being foun">
<meta property="og:type" content="article">
<meta property="og:title" content="揭秘浏览器远程调试技术">
<meta property="og:url" content="http://taobaofed.org/blog/2016/10/19/chrome-remote-debugging-technics/index.html">
<meta property="og:site_name" content="Taobao FED | 淘宝前端团队">
<meta property="og:description" content="调试技术的起源1947 年 9 月 9 日，一名美国的科学家格蕾丝.霍普和她的同伴在对 Mark II 计算机进行研究的时候发现，一只飞蛾粘在一个继电器上，导致计算机无法正常工作，当他们把飞蛾移除之后，计算机又恢复了正常运转。于是他们将这只飞蛾贴在了他们当时记录的日志上，对这件事情进行了详细的记录，并在日志最后写了这样一句话：First actual case of bug being foun">
<meta property="og:image" content="https://img.alicdn.com/tfs/TB1MZ9aNVXXXXaQXFXXXXXXXXXX-900-500.jpg">
<meta property="og:image" content="https://img.alicdn.com/tps/TB1f_n8NpXXXXXBXpXXXXXXXXXX-740-583.jpg">
<meta property="og:image" content="https://img.alicdn.com/tps/TB1KA.XNpXXXXbFXFXXXXXXXXXX-1021-336.png">
<meta property="og:image" content="https://img.alicdn.com/tps/TB1.H3kNpXXXXalXVXXXXXXXXXX-740-191.png">
<meta property="og:image" content="https://img.alicdn.com/tps/TB1h2UANpXXXXaYXpXXXXXXXXXX-912-214.png">
<meta property="og:image" content="https://img.alicdn.com/tps/TB1h2UANpXXXXaYXpXXXXXXXXXX-912-214.png">
<meta property="og:updated_time" content="2017-07-28T01:56:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="揭秘浏览器远程调试技术">
<meta name="twitter:description" content="调试技术的起源1947 年 9 月 9 日，一名美国的科学家格蕾丝.霍普和她的同伴在对 Mark II 计算机进行研究的时候发现，一只飞蛾粘在一个继电器上，导致计算机无法正常工作，当他们把飞蛾移除之后，计算机又恢复了正常运转。于是他们将这只飞蛾贴在了他们当时记录的日志上，对这件事情进行了详细的记录，并在日志最后写了这样一句话：First actual case of bug being foun">
<meta name="twitter:image" content="https://img.alicdn.com/tfs/TB1MZ9aNVXXXXaQXFXXXXXXXXXX-900-500.jpg">
  
    <link rel="alternative" href="http://taobaofed.org/atom.xml" title="Taobao FED | 淘宝前端团队" type="application/atom+xml">
    <link rel="alternative" href="http://taobaofed.org/atom.xml" title="Taobao FED | 淘宝前端团队" type="application/rss+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  

  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  
    <link rel="stylesheet" href="/scrollLoading/style.css">
  

  
    <style type="text/css">
      .logo { background-image:url(//img.alicdn.com/tps/TB1Nv_wKXXXXXbmXVXXXXXXXXXX-295-195.png); }
    </style>
  

  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <script src="/js/jquery-2.1.3.min.js"></script>
</head>

<body>
  <img src="//img.alicdn.com/tps/TB1GKckKXXXXXXIXpXXXXXXXXXX-400-400.png" alt="Taobao FED" style="position:absolute;left:-9999px">
  <div id="wrap">
    <header id="header">
  <div id="header-outer" class="outer">
    <div class="container">
      <div class="container-inner">
        <div id="header-title">
          <h1 class="logo-wrap">
            <a href="/" class="logo"></a>
          </h1>
          
            <h2 class="subtitle-wrap">
              <p class="subtitle">淘宝前端团队（FED）</p>
              <p class="description">用技术为体验提供无限可能</p>
            </h2>
          
        </div>
        <div id="header-inner" class="nav-container">
          <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
          <div class="nav-container-inner">
            <ul id="main-nav">
              <li class="main-nav-list-item" ><a class="main-nav-list-link" href="/">主页</a></li>
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/categories/Web开发/">Web开发</a>
                </li>
                
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/categories/Node-js/">Node.js</a>
                </li>
                
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/categories/无线开发/">无线开发</a>
                </li>
                
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/categories/工具-平台/">工具&amp;平台</a>
                </li>
                
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/categories/团队生活/">团队生活</a>
                </li>
                
              
                
                <li class="main-nav-list-item" >
                  <a class="main-nav-list-link" href="/about/">关于我们</a>
                </li>
                
              
            </ul>
            <nav id="sub-nav">
              <div id="search-form-wrap">
                <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="搜索"><input type="hidden" name="sitesearch" value="http://taobaofed.org"></form>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
    <div class="container">
      <div class="main-body container-inner">
        <div class="main-body-inner">
          <section id="main">
            <div class="main-body-header">

              <h1 class="header"><a class="page-title-link" href="/categories/工具-平台/">工具&平台</a></h1>
            </div>
            <div class="main-body-content">
              
  <article id="post-chrome-remote-debugging-technics" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
      <!--  -->
      
        <header class="article-header">
          
  
    <h1 class="article-title" itemprop="name">
      揭秘浏览器远程调试技术
    </h1>
  

        </header>
      
      <p class="article-byline">
        
        <span>作者: 肖焉
        </span>
        <span>发表于: <a href="/blog/2016/10/19/chrome-remote-debugging-technics/" class="article-date">
  <time datetime="2016-10-19T07:15:15.000Z" itemprop="datePublished">2016-10-19</time>
</a></span>
      </p>
      <div class="article-entry" itemprop="articleBody">
        <p><img src="https://img.alicdn.com/tfs/TB1MZ9aNVXXXXaQXFXXXXXXXXXX-900-500.jpg" alt="揭秘浏览器远程调试技术"></p>
<h2 id="调试技术的起源"><a href="#调试技术的起源" class="headerlink" title="调试技术的起源"></a>调试技术的起源</h2><p>1947 年 9 月 9 日，一名美国的科学家格蕾丝.霍普和她的同伴在对 Mark II 计算机进行研究的时候发现，一只飞蛾粘在一个继电器上，导致计算机无法正常工作，当他们把飞蛾移除之后，计算机又恢复了正常运转。于是他们将这只飞蛾贴在了他们当时记录的日志上，对这件事情进行了详细的记录，并在日志最后写了这样一句话：First actual case of bug being found。这是他们发现的第一个真正意义上的 bug，这也是人类计算机软件历史上，发现的第一个 bug，而他们找到飞蛾的方法和过程，就是 debugging 调试技术。</p>
<p><img src="https://img.alicdn.com/tps/TB1f_n8NpXXXXXBXpXXXXXXXXXX-740-583.jpg" alt="History of Debug"></p>
<p>从格蕾丝调试第一个 bug 到现在，69 年的时间里，在计算机领域，硬件、软件各种调试技术都在不断的发展和演进。那么对于日新月异的前端来说，调试技术也尤其显得重要。淘宝前端团队也正在使用一些创新的技术和手段来解决无线页面调试的问题。今天先跟大家分享下浏览器远程调试技术，本文将用 Chrome/Webview 来作为案例。</p>
<h2 id="调试原理"><a href="#调试原理" class="headerlink" title="调试原理"></a>调试原理</h2><h3 id="调试方式与权限管理"><a href="#调试方式与权限管理" class="headerlink" title="调试方式与权限管理"></a>调试方式与权限管理</h3><p><img src="https://img.alicdn.com/tps/TB1KA.XNpXXXXbFXFXXXXXXXXXX-1021-336.png" alt="-"></p>
<p>目前常规浏览器调试目标分为两种：Chrome PC 浏览器和 Chrome Mobile（Android 4.4 以后，Android WebView 其实就是 Chromium WebView）。</p>
<h4 id="Chrome-PC-浏览器"><a href="#Chrome-PC-浏览器" class="headerlink" title="Chrome PC 浏览器"></a>Chrome PC 浏览器</h4><p>对于调试 Chrome PC 浏览器，可能大家经常使用的是用鼠标右键或者快捷方式（mac:option + command + J），唤起 Chrome 的控制台，来对当前页面进行调试。其实还有另外一种方法，就是使用一个 Chrome 浏览器调试另一个 Chrome 浏览器。Chrome 启动的时候，默认是关闭了调试端口的，如果要对一个目标 Chrome PC 浏览器进行调试，那么启动的时候，可以通过传递参数来开启 Chrome 的调试开关：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for mac</span></span><br><span class="line">sudo /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222</span><br></pre></td></tr></table></figure>
<h4 id="Chrome-Android-浏览器"><a href="#Chrome-Android-浏览器" class="headerlink" title="Chrome Android 浏览器"></a>Chrome Android 浏览器</h4><p>对于调试 Android 上的 Chrome 或者 WebView 需要连接 USB 线。打开调试端口的方法如下：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:9222 localabstract:chrome_devtools_remote</span><br></pre></td></tr></table></figure></p>
<p>跟 Chrome PC 浏览器不同的是，对于 Chrome Android 浏览器，由于数据传输是通过 USB 线而不是 WIFI，实际上 Chrome Android 创建的一个 chrome_devtools_remote 这个 path 的 domain socket。所以，上面一条命令则是通过 Android 的 adb 将 PC 的端口 9222 通过 USB 线与 chrome_devtools_remote 这个 domain socket 建立了一个端口映射。</p>
<h4 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h4><p>Google 为了限制调试端口的接入范围，对于 Chrome PC 浏览器，调试端口只接受来自 <code>127.0.0.1</code> 或者 <code>localhost</code> 的数据请求，所以，你无法通过你的本地机器 IP 来调试 Chrome。对于 Android Chrome/WebView，调试端口只接受来自于 <code>shell</code> 这个用户数据请求，也就是说只能通过 USB 进行调试，而不能通过 WIFI。</p>
<h3 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h3><p>通过以上的调试方式的接入以及调试端口的打开，这个时候在浏览器中输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9222/json</span><br></pre></td></tr></table></figure></p>
<p>将会看到类似下面的内容：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"devtoolsFrontendUrl"</span>: <span class="string">"/devtools/inspector.html?ws=127.0.0.1:9222/devtools/page/ebdace60-d482-4340-b622-a6198e7aad6e"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"ebdace60-d482-4340-b622-a6198e7aad6e"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"揭秘浏览器远程调试技术.mdown—/Users/harlen/Documents"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"page"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"http://127.0.0.1:51004/view/61"</span>,</span><br><span class="line">    <span class="attr">"webSocketDebuggerUrl"</span>: <span class="string">"ws://127.0.0.1:9222/devtools/page/ebdace60-d482-4340-b622-a6198e7aad6e"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>其中，最重要的 2 个参数分别是 id 和 webSocketDebuggerUrl。Chrome 会为每个页面分配一个唯一的 id，作为该页面的唯一标识符。几乎对目标浏览器的所有操作都是需要带上这个 id。</p>
<p>Chrome 提供了以下这些 http 接口控制目标浏览器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取当前所有可调式页面信息</span></span><br><span class="line">http://127.0.0.1:9222/json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取调试目标 WebView/blink 的版本号</span></span><br><span class="line">http://127.0.0.1:9222/json/version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新的 tab，并加载 url</span></span><br><span class="line">http://127.0.0.1:9222/json/new?url</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 id 对应的 tab</span></span><br><span class="line">http://127.0.0.1:9222/json/close/id</span><br></pre></td></tr></table></figure></p>
<p>webSocketDebuggerUrl 则在调试该页面需要用到的一个 WebSocket 连接。chrome 的 devtool 的所有调试功能，都是基于 <a href="https://chromedevtools.github.io/debugger-protocol-viewer/1-1/Debugger/" target="_blank" rel="external">Remote Debugging Protocol</a> 使用 WebSocket 来进行数据传输的。那么这个 WebSocket，就是上面我们从 <code>http://127.0.0.1:9222/json</code> 获取的 <code>webSocketDebuggerUrl</code>，每一个页面都有自己不同的 <code>webSocketDebuggerUrl</code>。这个 <code>webSocketDebuggerUrl</code>是通过 url 的 query 参数传递给 chrome devtool 的。</p>
<p>chrome 的 devtool 可以从 Chrome 浏览器中进行提取 devtool 源码或者从 blink 源码中获取。在部署好自己的 chrome devtool 代码之后，下面既可以开始对 Chrome 进行调试, 浏览器输入一下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://path_to_your_devtool/devtool.html?ws=127.0.0.1:9222/devtools/page/ebdace60-d482-4340-b622-a6198e7aad6e</span><br></pre></td></tr></table></figure></p>
<p>其中 ws 这个参数的值就是上面出现的 webSocketDebuggerUrl。Chrome 的 devtool 会使用这个 url 创建 WebSocket 对该页面进行调试。</p>
<h3 id="如何实现-JavaScript-调试"><a href="#如何实现-JavaScript-调试" class="headerlink" title="如何实现 JavaScript 调试"></a>如何实现 JavaScript 调试</h3><p>在进入 Chrome 的 devtool 之后，我们可以调出控制台，来查看 devtool 的 WebSocket 数据。这个里面有很多数据，我这里只讲跟 JavaScript 调试相关的。<br><img src="https://img.alicdn.com/tps/TB1.H3kNpXXXXalXVXXXXXXXXXX-740-191.png" alt="-"></p>
<p>图中，对于 JavaScript 调试，有一条非常重要的消息，我蓝色选中的那条消息：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"id"</span>:<span class="number">6</span>,<span class="attr">"method"</span>:<span class="string">"Debugger.enable"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后选中要调试的 JavaScript 文件，然后设置一个断点，我们再来看看 WebSocket 消息：<br><img src="https://img.alicdn.com/tps/TB1h2UANpXXXXaYXpXXXXXXXXXX-912-214.png" alt="-"></p>
<p>devtool 像目标 Chrome 发送了 2 条消息<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">23</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"Debugger.getScriptSource"</span>,</span><br><span class="line">  <span class="attr">"params"</span>: &#123;</span><br><span class="line">    <span class="attr">"scriptId"</span>: <span class="string">"103"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"Debugger.setBreakpointByUrl"</span>,</span><br><span class="line">  <span class="attr">"params"</span>: &#123;</span><br><span class="line">    <span class="attr">"lineNumber"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"https://g.alicdn.com/alilog/wlog/0.2.10/??aplus_wap.js,spm_wap.js,spmact_wap.js"</span>,</span><br><span class="line">    <span class="attr">"columnNumber"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"condition"</span>: <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么收到这几条消息之后，V8 做了些什么呢？<br>我们先来简单的看下 V8 里面的一小段源码片段：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// V8 Debugger.cpp</span></span><br><span class="line">DispatcherImpl(FrontendChannel* frontendChannel, Backend* backend) : DispatcherBase(frontendChannel), m_backend(backend) &#123;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.enable"</span>] = &amp;DispatcherImpl::enable;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.disable"</span>] = &amp;DispatcherImpl::disable;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setBreakpointsActive"</span>] = &amp;DispatcherImpl::setBreakpointsActive;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setSkipAllPauses"</span>] = &amp;DispatcherImpl::setSkipAllPauses;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setBreakpointByUrl"</span>] = &amp;DispatcherImpl::setBreakpointByUrl;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setBreakpoint"</span>] = &amp;DispatcherImpl::setBreakpoint;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.removeBreakpoint"</span>] = &amp;DispatcherImpl::removeBreakpoint;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.continueToLocation"</span>] = &amp;DispatcherImpl::continueToLocation;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.stepOver"</span>] = &amp;DispatcherImpl::stepOver;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.stepInto"</span>] = &amp;DispatcherImpl::stepInto;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.stepOut"</span>] = &amp;DispatcherImpl::stepOut;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.pause"</span>] = &amp;DispatcherImpl::pause;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.resume"</span>] = &amp;DispatcherImpl::resume;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.searchInContent"</span>] = &amp;DispatcherImpl::searchInContent;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setScriptSource"</span>] = &amp;DispatcherImpl::setScriptSource;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.restartFrame"</span>] = &amp;DispatcherImpl::restartFrame;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.getScriptSource"</span>] = &amp;DispatcherImpl::getScriptSource;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setPauseOnExceptions"</span>] = &amp;DispatcherImpl::setPauseOnExceptions;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.evaluateOnCallFrame"</span>] = &amp;DispatcherImpl::evaluateOnCallFrame;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setVariableValue"</span>] = &amp;DispatcherImpl::setVariableValue;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setAsyncCallStackDepth"</span>] = &amp;DispatcherImpl::setAsyncCallStackDepth;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setBlackboxPatterns"</span>] = &amp;DispatcherImpl::setBlackboxPatterns;</span><br><span class="line">    m_dispatchMap[<span class="string">"Debugger.setBlackboxedRanges"</span>] = &amp;DispatcherImpl::setBlackboxedRanges;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你会发现，V8 有 <code>m_dispatchMap</code> 这样一个 Map。专门用来处理所有 JavaScript 调试相关的处理。<br>其中就有本文即将重点讲述的:</p>
<ul>
<li>Debuggger.enable</li>
<li>Debugger.getScriptSource</li>
<li>setBreakpointByUrl</li>
</ul>
<p>这些都需要在 V8 的源码中找到答案。顺便给大家推荐一个查看 Chromium/V8 最正确的方式是使用 <a href="https://cs.chromium.org/" target="_blank" rel="external">https://cs.chromium.org</a>，比 SourceInsight 还要方便。</p>
<h4 id="Debugger-enable"><a href="#Debugger-enable" class="headerlink" title="Debugger.enable"></a>Debugger.enable</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> V8Debugger::enable() &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_enableCount++) <span class="keyword">return</span>;</span><br><span class="line">    DCHECK(!enabled());</span><br><span class="line">    v8::<span class="function">HandleScope <span class="title">scope</span><span class="params">(m_isolate)</span></span>;</span><br><span class="line">    v8::Debug::SetDebugEventListener(m_isolate, &amp;V8Debugger::v8DebugEventCallback,</span><br><span class="line">    v8::External::New(m_isolate, <span class="keyword">this</span>));</span><br><span class="line">    m_debuggerContext.Reset(m_isolate, v8::Debug::GetDebugContext(m_isolate));</span><br><span class="line">    compileDebuggerScript();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口的名称叫 <code>Debugger.enable</code>，但是收到这条消息，V8 其实就干了两件事情事情：</p>
<ul>
<li><p>SetDebugEventListener：<br>给 JavaScript 调试安装监听器，并设置 <code>v8DebugEventCallback</code> 这个回调函数。JavaScript 所有的调试事件，都会被这个监听器捕获，包括：JavaScript 异常停止，断点停止，单步调试等等。</p>
</li>
<li><p>compileDebuggerScript:<br>编译 V8 内置的 JavaScript 文件 <a href="https://cs.chromium.org/chromium/src/v8/src/inspector/debugger-script.js?q=debugger-script.js&amp;sq=package:chromium&amp;dr" target="_blank" rel="external">debugger-script.js</a>。由于这文件比较长，我这里就不贴出来了，感兴趣的同学点击这个链接进行查看源码。<code>debugger-script.js</code> 主要是定义了一些针对 JavaScript 断点进行操作的函数，例如设置断点、查找断点以及单步调试相关的函数。那么这个 <code>debugger-script.js</code> 文件，被 V8 进行编译之后，保存在 global 对象上，等待对 JavaScript 进行调试的时候，被调用。</p>
<h4 id="Debugger-getScriptSource"><a href="#Debugger-getScriptSource" class="headerlink" title="Debugger.getScriptSource"></a>Debugger.getScriptSource</h4><p>在 Chrome 解析引擎解析到 <code>&lt;script&gt;</code> 标签之后，Chrome 将会把 script 标签对应的 JavaScript 源码扔给 V8 编译执行。同时，V8 将会对所有的 JavaScript 源码片段进行编号并保存。所以，当 chrome devtool 需要获取要调试的 JavaScript 文件的时候，只需要通过 <code>Debugger.getScriptSource</code>，给 V8 传递一个 scriptId，V8 将会把 JavaScript 源码返回。我们再回头看看这个图中的消息：<br><img src="https://img.alicdn.com/tps/TB1h2UANpXXXXaYXpXXXXXXXXXX-912-214.png" alt="-"><br>上面 id 为 23 的 <code>scriptSource</code> 就是 V8 返回的 JavaScript 源码，如此以来，我们就可以在 devtool 中看到我们要调试的 JavaScript 源码了。</p>
</li>
</ul>
<h4 id="Debugger-setBreakpointByUrl"><a href="#Debugger-setBreakpointByUrl" class="headerlink" title="Debugger.setBreakpointByUrl"></a>Debugger.setBreakpointByUrl</h4><p>所有准备工作都做好了，现在就可以开始设置断点了。从上面的几个图中，已经可以很清楚的看到，<code>Debugger.setBreakpointByUrl</code> 给目标 Chrome 传递了一个 JavaScript 的 url 和断点的行号。</p>
<p>首先，V8 会去找，是否已经存在了该 URL 对应的 JavaScript 源码了：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; script : m_scripts) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!matches(m_inspector, script.second-&gt;sourceURL(), url, isRegex))</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;protocol::Debugger::Location&gt; location = resolveBreakpoint(</span><br><span class="line">    breakpointId, script.first, breakpoint, UserBreakpointSource);</span><br><span class="line">  <span class="keyword">if</span> (location) (*locations)-&gt;addItem(<span class="built_in">std</span>::move(location));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*outBreakpointId = breakpointId;</span><br></pre></td></tr></table></figure></p>
<p>V8 给所有的断点，创建一个 breakpointObject。并将这些 braekpointObject 以 <key, value=""> 的形式存放在一个 Map 里面，而这个 Key，就是这个 JavaScript 文件的 URL。看到这里，已经可以解释很多同学在调试 JavaScript 遇到的一个问题：</key,></p>
<blockquote>
<p>有些同学为了防止页面的 JavaScript 文件不更新，对于一些重要的 JavaScript 文件的 URL 添加访问时间戳，对于这些添加了访问时间戳的 JavaScript 文件进行设置断点然后刷新调试的时候，Chrome 会打印一个 warnning，告诉你断点丢失。</p>
</blockquote>
<p>原因很简单，在调试的时候，V8 发现这个 breakpointMap 里面找不到对应的 breakpointObject，因为 URL 发生了变化，这个 brakpointObject 就丢失了，所以 V8 就找不到了，无法进行断点调试。</p>
<p>根据我们的正常思维，你可能会认为 V8 会将断点设置在 C++ 中，其实一开始我也是这么认为。随着对 V8 的探索，让我看到了我时曾相识的一些函数名：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v8::Local&lt;v8::Function&gt; setBreakpointFunction = v8::Local&lt;v8::Function&gt;::Cast(</span><br><span class="line">    m_debuggerScript.Get(m_isolate)</span><br><span class="line">    -&gt;Get(context, toV8StringInternalized(m_isolate, <span class="string">"setBreakpoint"</span>))</span><br><span class="line">      .ToLocalChecked());</span><br><span class="line">v8::Local&lt;v8::Value&gt; breakpointId =</span><br><span class="line">  v8::Debug::Call(debuggerContext(), setBreakpointFunction, info)</span><br><span class="line">    .ToLocalChecked();</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>m_debuggerScript</code>，就是我前面提到的 <code>debugger-script.js</code>。随着对 V8 Debugger 的进一步探索，我发现，V8 实际上对这个对这个 breakpointObject 设置了 2 次。一次是通过在 C++ 中调用 m_debuggerScript 的 setBreakpoint 设置到 JavaScript 的 context 里面，也就是上面这段 C++ 逻辑做的事情。另一次是，<code>m_debuggerScript</code> 反过来将断点信息设置到了 V8 的 C++ Runtime 中，为要调试的 JavaScript 的某一行设置一个 JavaScript 的回调函数。</p>
<h4 id="断点命中"><a href="#断点命中" class="headerlink" title="断点命中"></a>断点命中</h4><p>由于 V8 对 JavaScript 是及时编译执行的，没有生成 bytecode，而是直接生成的 machine code 执行的，所以这个断点回调函数也会被设置到这个 machine code 里面。</p>
<p>最终触发断点事件，也是 V8 的 C++ Runtime。当用户刷新或者直接执行 JavaScript 的逻辑的时候，实际上是 V8 C++ Runtime 在运行 JavaScript 片段产生的 machine code，这个 machine code 已经包含了断点回调函数了。一旦这个 machine code 里面的回调函数被触发，接着就会触发之前 Debugger.enable 设置的调试事件监听器 DebugEventListener 的回调函数。并返回一条消息给 Chrome 的 devtool，告诉 Chrome devtool，当前 JavaScript 被 pause 的行号。到此为止，一个断点就被命中了。</p>
<p>关于 JavaScript 断点命中，其实是一个很复杂的过程。后面有时间的话，会专门讲讲 JavaScript 断点命中的详细逻辑。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>浏览器的调试，最终都落脚到引擎：渲染引擎和 JavaScipt 引擎。那么对于 JavaScript 调试来说，难点就在于 V8 如何给 JavaScript 某一行进行标记然后进行断点，这需要有一点 V8 的知识。</p>

      </div>
      <footer class="article-footer">
        <a data-url="http://taobaofed.org/blog/2016/10/19/chrome-remote-debugging-technics/" data-id="cj5n8gtug000n98t3cfhihig6" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
        
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/远程调试/">远程调试</a></li></ul>

      </footer>
    </div>
  </article>
  
  
  <section id="comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function() {
        this.page.url = 'http://taobaofed.org' + location.pathname;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://taobaofed.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
  </section>
  


            </div>
          </section>
          <aside id="sidebar">
  <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
  <div class="sidebar-top">
    <p>关注我们 :</p>
    <ul class="social-links">
      
        <li><a class="social-tooltip" title="github" href="https://github.com/taobaofed" target="_blank"><i class="icon fa fa-github"></i></a></li>
      
        <li><a class="social-tooltip" title="weibo" href="http://weibo.com/taobaofed" target="_blank"><i class="icon fa fa-weibo"></i></a></li>
      
        <li><a class="social-tooltip" title="rss" href="/atom.xml" target="_blank"><i class="icon fa fa-rss"></i></a></li>
      
    </ul>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/10/27/how-to-hack-nodejs-modules/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <p class="article-nav-title">
        
          如何 hack Node.js 模块？
        
      </p>
      <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
  
  
    <a href="/blog/2016/10/11/thinking-in-velocity-nyc-2016/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <p class="article-nav-title">Velocity NYC 2016 参会总结</p>
      <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
    </a>
  
</nav>

  
  <div class="widgets-container">
    
      <div class="widget-wrap widget-open-source">
  <!--<h3 class="widget-title">开源产品</h3>-->
  
  <a href="https://github.com/alibaba/rax" target="_blank">
    <img src="//gw.alicdn.com/tps/TB1psKfPVXXXXaxXpXXXXXXXXXX-560-200.png" width="280" alt="A universal React-compatible render engine." title="A universal React-compatible render engine.">
  </a>
  
  <a href="https://github.com/taobaofed/react-web" target="_blank">
    <img src="//gw.alicdn.com/tfs/TB1yUyQPpXXXXbKaXXXXXXXXXXX-280-100.jpg" width="280" alt="A framework for building web apps with React Native compatible API." title="A framework for building web apps with React Native compatible API.">
  </a>
  
</div>

    
      
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul id="recent-post" class="">
        
          <li>
            
            <div class="item-thumbnail">
              
<a href="/blog/2017/07/27/gcanvas/" class="thumbnail">
  
    <span style="background-image:url(https://gw.alicdn.com/tfs/TB1sakpSpXXXXaAXFXXXXXXXXXX-900-500.jpg
)" alt="GCanvas 渲染引擎介绍" class="thumbnail-image"></span>
  
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/无线开发/">无线开发</a></p>
              <p class="item-title"><a href="/blog/2017/07/27/gcanvas/" class="title">GCanvas 渲染引擎介绍</a></p>
              
              <p class="item-author">by 韦青</p>
              
              <p class="item-date">at <time datetime="2017-07-27T08:49:59.000Z" itemprop="datePublished">2017-07-27</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              
<a href="/blog/2017/07/04/leveldb-analysis/" class="thumbnail">
  
    <span style="background-image:url(https://gw.alicdn.com/tfs/TB1R1S4SXXXXXaRXpXXXXXXXXXX-900-500.jpg
)" alt="LevelDB 实现分析" class="thumbnail-image"></span>
  
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/无线开发/">无线开发</a></p>
              <p class="item-title"><a href="/blog/2017/07/04/leveldb-analysis/" class="title">LevelDB 实现分析</a></p>
              
              <p class="item-author">by 胡帅</p>
              
              <p class="item-date">at <time datetime="2017-07-04T09:32:29.000Z" itemprop="datePublished">2017-07-04</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              
<a href="/blog/2017/05/18/how-to-display-git-diff/" class="thumbnail">
  
    <span style="background-image:url(https://gw.alicdn.com/tfs/TB1_6wnRXXXXXbwXFXXXXXXXXXX-900-500.jpg
)" alt="如何实现一个 Git Diff 解析器" class="thumbnail-image"></span>
  
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Web开发/">Web开发</a></p>
              <p class="item-title"><a href="/blog/2017/05/18/how-to-display-git-diff/" class="title">如何实现一个 Git Diff 解析器</a></p>
              
              <p class="item-author">by 栖邀</p>
              
              <p class="item-date">at <time datetime="2017-05-18T01:56:11.000Z" itemprop="datePublished">2017-05-18</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              
<a href="/blog/2017/04/27/building-consistent-api-with-es-decorators/" class="thumbnail">
  
    <span style="background-image:url(https://gw.alicdn.com/tfs/TB1uGueQVXXXXbCXVXXXXXXXXXX-900-500.png
)" alt="使用 ES decorators 构建一致性 API" class="thumbnail-image"></span>
  
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Web开发/">Web开发</a></p>
              <p class="item-title"><a href="/blog/2017/04/27/building-consistent-api-with-es-decorators/" class="title">使用 ES decorators 构建一致性 API</a></p>
              
              <p class="item-author">by 法海</p>
              
              <p class="item-date">at <time datetime="2017-04-26T22:59:16.000Z" itemprop="datePublished">2017-04-27</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              
<a href="/blog/2017/03/24/node-subway-season-4-nanjing/" class="thumbnail">
  
    <span style="background-image:url(https://gw.alicdn.com/tfs/TB1kHkiQXXXXXX9XVXXXXXXXXXX-900-500.jpg
)" alt="「深入实践中的 Node.js」- Node 地下铁第四期南京站线下沙龙总结" class="thumbnail-image"></span>
  
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Web开发/">Web开发</a></p>
              <p class="item-title"><a href="/blog/2017/03/24/node-subway-season-4-nanjing/" class="title">「深入实践中的 Node.js」- Node 地下铁第四期南京站线下沙龙总结</a></p>
              
              <p class="item-author">by 煜宸</p>
              
              <p class="item-date">at <time datetime="2017-03-23T23:31:45.000Z" itemprop="datePublished">2017-03-24</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-wechat">
    <h3 class="widget-title">微信公众号</h3>
    <a href="https://github.com/alibaba/rax ">
      <img src="//img.alicdn.com/tfs/TB12fzTMVXXXXafaXXXXXXXXXXX-280-280.jpg" width="280" alt="淘宝前端团队微信公众号（taobaofed）" title="淘宝前端团队微信公众号（taobaofed）">
    </a>
  </div>

    
      
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web开发/">Web开发</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/团队生活/">团队生活</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具-平台/">工具&平台</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/无线开发/">无线开发</a><span class="category-list-count">21</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">58</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/">2015</a><span class="archive-list-count">51</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/">2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/">2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/">2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/">2010</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/">2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/">2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/">2007</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://nodejs.club/">Node 地下铁</a>
          </li>
        
          <li>
            <a href="http://alinode.aliyun.com/">alinode</a>
          </li>
        
          <li>
            <a href="http://fex.baidu.com/">百度 FEX</a>
          </li>
        
          <li>
            <a href="http://www.75team.com/">奇舞团</a>
          </li>
        
          <li>
            <a href="http://aotu.io/notes/">凹凸实验室</a>
          </li>
        
          <li>
            <a href="http://www.alloyteam.com/">腾讯 AlloyTeam</a>
          </li>
        
      </ul>
    </div>
  </div>


    
  </div>
</aside>
        </div>
      </div>
    </div>
    <footer id="footer">
  
  <div class="container">
    <div class="container-inner">
      <!-- <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a> -->
      <div class="credit">
        <p>Copyright &copy; 2017 Taobao FED. All rights reserved.</p>
        <a href="/terms">版权声明</a>
        <!-- <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a> Redesigned by <a href="http://barretlee.com/" target="_blank">barretlee</a></p> -->
      </div>
    </div>
  </div>
</footer>
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-65944345-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<script>
// for baidu spider
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
// for baidu analysis
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?33dd75d7b88de8722970ea06fa5f06b0";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
    
  <script src="/fancybox/jquery.fancybox.pack.js"></script>



  <script src="/scrollLoading/jquery.scrollLoading.js"></script>
  <script src="/scrollLoading/main.js"></script>


<script src="/js/html-patch.js"></script>
<script src="/js/script.js"></script>

  </div>
</body>
</html>
